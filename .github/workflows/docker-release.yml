name: Build and Push Docker Image

run-name: Deploy ${{ github.ref_name }} (By ${{ github.actor }})

on:
  workflow_dispatch:
    inputs:
      tag:
        description: 'The tag to build the Docker image from'
        type: string
        required: true

env:
  TAG: ${{ inputs.tag }}

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout source code
      uses: actions/checkout@v2
      with:
        ref: ${{ inputs.tag }}
        submodules: 'recursive'

    - name: Build Docker image
      env:
        DOCKER_BUILDKIT: 1
      run: |
        BUILD_DATE=$(date +"%Y-%m-%dT%H:%M:%S:%z")
        VCS_REF=$(git rev-list -1 HEAD)

        docker build \
          --build-arg UID=${{ vars.DOCKER_UID }} \
          --build-arg GID=${{ vars.DOCKER_GID }} \
          --build-arg BUILD_DATE=$BUILD_DATE \
          --build-arg VCS_REF=$VCS_REF \
          --build-arg VERSION=${{ inputs.tag }} \
          -t jisunglim/erigon:${{ inputs.tag }} .

    - name: Push Docker image
      env:
        DOCKER_USERNAME: ${{ secrets.DOCKER_USERNAME }}
        DOCKER_PASSWORD: ${{ secrets.DOCKER_PASSWORD }}
      run: |
        echo "${DOCKER_PASSWORD}" | docker login -u "${DOCKER_USERNAME}" --password-stdin
        docker push jisunglim/erigon:${{ inputs.tag }}
